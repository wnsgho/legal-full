version: "3.8"

services:
  # 백엔드 서버
  backend:
    build:
      context: ./BE
      dockerfile: Dockerfile
    container_name: autoschema-backend
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      # 로컬 Neo4j Desktop 연결 (host.docker.internal = 호스트 머신)
      - NEO4J_URI=${NEO4J_URI:-neo4j://host.docker.internal:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4.1-2025-04-14.1}
      - DEFAULT_EMBEDDING_MODEL=${DEFAULT_EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # 파이프라인 경로 설정 (Docker 컨테이너 내부 경로)
      - DATA_DIRECTORY=example_data
      - OUTPUT_DIRECTORY=output
      - LOG_DIRECTORY=log
      - IMPORT_DIRECTORY=import
      - PRECOMPUTE_DIRECTORY=precompute
    ports:
      - "8000:8000"
    volumes:
      # 업로드 파일 (호스트 <-> 컨테이너 공유)
      - ./uploads:/uploads
      # 데이터 디렉토리 (파이프라인 입력 파일)
      - ./BE/example_data:/app/example_data
      # 출력/로그/임포트 디렉토리
      - ./BE/output:/app/output
      - ./BE/import:/app/import
      - ./BE/log:/app/log
      # precompute 디렉토리 (RAG 인덱스 저장)
      - ./BE/precompute:/app/precompute
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - autoschema-network
    restart: unless-stopped

  # 프론트엔드 서버
  frontend:
    build:
      context: ./FE/workspace/shadcn-ui
      dockerfile: Dockerfile
      args:
        # Docker 환경에서는 nginx가 프록시하므로 빈 문자열 사용 (상대 경로)
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-}
        - VITE_APP_TITLE=${VITE_APP_TITLE:-계약서 분석 AI}
        # Docker에서 호스트의 Neo4j에 접근하려면 host.docker.internal 사용
        - VITE_NEO4J_URI=${VITE_NEO4J_URI:-bolt://host.docker.internal:7687}
        - VITE_NEO4J_USER=${NEO4J_USER:-neo4j}
        - VITE_NEO4J_PASSWORD=${NEO4J_PASSWORD}
        - VITE_NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
    container_name: autoschema-frontend
    ports:
      - "3000:80"
    networks:
      - autoschema-network
    depends_on:
      - backend
    restart: unless-stopped

networks:
  autoschema-network:
    driver: bridge
